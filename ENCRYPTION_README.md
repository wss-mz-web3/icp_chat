# 端到端加密说明

## 工作原理

本应用使用 **AES-GCM 256位加密** 实现端到端加密。每条消息在发送前会被加密，只有拥有正确密钥的用户才能解密。

## 密钥管理

- **密钥存储**：每个浏览器/设备在首次使用时自动生成一个加密密钥，存储在浏览器的 `localStorage` 中
- **密钥独立性**：每个设备都有独立的密钥，不同设备之间无法互相解密消息
- **密钥标识**：密钥标识符为 `icp_chat_encryption_key`

## 解密失败的原因

### 1. **密钥不匹配（最常见）**

**原因**：
- 消息是由其他设备/浏览器加密的
- 每个设备都有独立的密钥，无法解密其他设备加密的消息
- 这是端到端加密的正常行为

**解决方案**：
- 这是预期行为，无法跨设备解密
- 如果需要跨设备访问，需要实现密钥同步机制（当前版本不支持）

### 2. **旧消息未加密**

**原因**：
- 在启用加密功能之前发送的消息是未加密的
- 代码会自动识别未加密消息并直接显示

**处理**：
- 代码已自动处理，未加密消息会正常显示

### 3. **浏览器数据被清除**

**原因**：
- 用户清除了浏览器数据（localStorage）
- 密钥丢失，无法解密之前加密的消息

**解决方案**：
- 清除浏览器数据会导致密钥丢失
- 建议用户不要清除浏览器数据，或实现密钥备份功能

### 4. **数据损坏**

**原因**：
- 传输或存储过程中数据被修改
- 网络传输错误

**处理**：
- 代码会返回原始加密文本，显示解密失败提示

## 环境配置

### 本地开发环境（DFX_NETWORK=local）

- **加密状态**：禁用
- **原因**：简化开发和调试
- **行为**：消息以明文发送和存储

### 生产环境（IC 网络）

- **加密状态**：启用
- **要求**：需要 HTTPS 或 localhost 访问（Web Crypto API 要求）
- **行为**：消息自动加密后发送

## 技术细节

### 加密算法
- **算法**：AES-GCM（Galois/Counter Mode）
- **密钥长度**：256位
- **IV 长度**：96位（12字节）
- **认证标签**：128位

### 消息格式
- **加密消息**：`encrypted:{base64_data}`
- **未加密消息**：直接文本（向后兼容）

### 加密流程
1. 生成随机 IV（初始化向量）
2. 使用 AES-GCM 加密文本
3. 将 IV 和加密数据组合
4. Base64 编码
5. 添加 `encrypted:` 前缀

### 解密流程
1. 检查是否有 `encrypted:` 前缀
2. 提取 Base64 数据
3. 解码并分离 IV 和加密数据
4. 使用密钥和 IV 解密
5. 返回解密后的文本

## 安全注意事项

1. **密钥安全**：密钥存储在浏览器 localStorage 中，清除数据会丢失密钥
2. **跨设备限制**：不同设备无法互相解密（这是端到端加密的特性）
3. **服务器可见性**：服务器只能看到加密后的消息，无法解密
4. **HTTPS 要求**：生产环境需要 HTTPS 才能使用 Web Crypto API

## 故障排查

### 消息显示 "🔒 无法解密此消息"

**可能原因**：
1. 消息由其他设备加密
2. 浏览器数据被清除
3. 使用了不同的浏览器

**解决方法**：
- 这是预期行为，无法跨设备解密
- 在同一设备上发送的新消息可以正常解密

### 控制台显示解密失败错误

**检查**：
1. 查看错误详情（密钥不匹配/数据损坏等）
2. 确认是否在正确的网络环境（IC 网络）
3. 确认浏览器是否支持 Web Crypto API

## 未来改进方向

1. **密钥同步**：实现跨设备密钥同步机制
2. **密钥备份**：允许用户导出/导入密钥
3. **密钥轮换**：定期更换加密密钥
4. **群组密钥**：支持群组聊天共享密钥

